<!-- file: force-app/main/default/lwc/leadEligibilityReview/leadEligibilityReview.html -->
<template>
    <lightning-card title="Eligibility File Verification" icon-name="custom:custom63">
        <!-- TOP PATH FOR GP LEAD STATUS (READ ONLY) -->
        <div class="ler-path-wrapper">
            <div class="path-header">
                <div>
                    <div class="path-label">Eligibility Status</div>
                    <div class="path-steps">
                        <template for:each={pathItems} for:item="step">
                            <div key={step.value} class={step.className}>
                                {step.label}
                            </div>
                        </template>
                    </div>
                </div>
                <div class="path-meta">
                    <template for:each={statusCountsSummary} for:item="stat">
                        <div key={stat.label} class="meta-pill">
                            {stat.label}: {stat.count}
                        </div>
                    </template>
                </div>
            </div>
        </div>

        <div class="ler-score-wrapper">
            <div class="score-block">
                <div class="score-label">Credit Score</div>
                <div class="score-value">{creditScoreDisplay}</div>
            </div>
            <div class="score-block">
                <div class="score-label">CPA Eligibility Status</div>
                <div class="score-value score-status">{cpaStatusDisplay}</div>
            </div>
            <lightning-button
                class="score-action"
                variant="brand"
                label="Calculate Eligibility Score"
                title="Calculate Eligibility Score"
                onclick={handleCalculateScore}
                disabled={isCalculateDisabled}>
            </lightning-button>
            <lightning-button
                class="score-action secondary"
                variant="neutral"
                label="Edit Eligibility"
                title="Edit Eligibility"
                onclick={openEditModal}
                disabled={isCalculateDisabled}>
            </lightning-button>
        </div>

        <div class="info-banner">
            <p>
                Once the user upload the data in MilesOne, it will be reflected here for verfication process.
            </p>
        </div>

        <div class="ler-container">
            <template if:true={hasData}>
                <!-- MESSAGE IF THERE ARE NO FILES ANYWHERE -->
                <template if:false={hasAnyFile}>
                    <div class="no-files-note">
                        No eligibility documents have been uploaded yet for this Lead.
                    </div>
                </template>

                <div class="root-list">
                    <template for:each={folderTree} for:item="root">
                        <article key={root.id} class="root-card">
                            <!-- ROOT ROW (UG / PG / Certificates) -->
                            <div class="row root-row row-hover" onclick={handleToggleFolder} data-id={root.id}>
                                <div class="row-left">
                                    <div class="chevron">
                                        <template if:true={root.expanded}>
                                            <lightning-icon icon-name="utility:chevrondown"
                                                            size="x-small"
                                                            alternative-text="Collapse">
                                            </lightning-icon>
                                        </template>
                                        <template if:false={root.expanded}>
                                            <lightning-icon icon-name="utility:chevronright"
                                                            size="x-small"
                                                            alternative-text="Expand">
                                            </lightning-icon>
                                        </template>
                                    </div>
                                    <lightning-icon icon-name="utility:open_folder"
                                                    size="small"
                                                    class="folder-icon folder-icon-root">
                                    </lightning-icon>
                                    <div class="title-block">
                                        <div class="title">
                                            {root.name}
                                        </div>
                                        <div class="subtitle">{root.subtitle}</div>

                                        <template if:true={root.statusSummary}>
                                            <div class="status-summary">
                                                {root.statusSummary}
                                            </div>
                                        </template>

                                        <template if:true={root.comments}>
                                            <div class="folder-comment">Comment: {root.comments}</div>
                                        </template>
                                    </div>
                                </div>

                                <div class="row-right">
                                    <template if:true={root.allowFolderEdit}>
                                        <lightning-button-icon
                                            icon-name="utility:edit"
                                            alternative-text="Edit Folder"
                                            title="Edit Folder"
                                            class="folder-comment-btn"
                                            data-id={root.id}
                                            onclick={handleFolderCommentClick}>
                                        </lightning-button-icon>
                                    </template>

                                    <template if:true={root.displayDate}>
                                        <span class="date-text">{root.displayDate}</span>
                                    </template>
                                    <template if:true={root.showStatus}>
                                        <span class={root.statusClass}>
                                            <span class="status-dot"></span>
                                            {root.status}
                                        </span>
                                    </template>
                                </div>
                            </div>

                            <!-- ROOT CONTENT (DEGREES + FILES) -->
                            <template if:true={root.expanded}>
                                <!-- Level 2: Degrees under root -->
                                <template if:true={root.children}>
                                    <template for:each={root.children} for:item="deg">
                                        <div key={deg.id} class="row-wrapper">
                                            <!-- DEGREE ROW -->
                                            <div class="row level-2-row row-hover" onclick={handleToggleFolder} data-id={deg.id}>
                                                <div class="row-left level-2-indent">
                                                    <div class="chevron">
                                                        <template if:true={deg.expanded}>
                                                            <lightning-icon icon-name="utility:chevrondown"
                                                                            size="x-small"
                                                                            alternative-text="Collapse">
                                                            </lightning-icon>
                                                        </template>
                                                        <template if:false={deg.expanded}>
                                                            <lightning-icon icon-name="utility:chevronright"
                                                                            size="x-small"
                                                                            alternative-text="Expand">
                                                            </lightning-icon>
                                                        </template>
                                                    </div>
                                                    <lightning-icon icon-name="utility:open_folder"
                                                                    size="small"
                                                                    class="folder-icon folder-icon-degree">
                                                    </lightning-icon>
                                                    <div class="title-block">
                                                        <div class="title">
                                                            {deg.name}
                                                        </div>
                                                        <div class="subtitle">{deg.subtitle}</div>

                                                        <template if:true={deg.statusSummary}>
                                                            <div class="status-summary">
                                                                {deg.statusSummary}
                                                            </div>
                                                        </template>

                                                        <template if:true={deg.comments}>
                                                            <div class="folder-comment">Comment: {deg.comments}</div>
                                                        </template>
                                                    </div>
                                                </div>

                                                <div class="row-right">
                                                    <template if:true={deg.allowFolderEdit}>
                                                        <lightning-button-icon
                                                            icon-name="utility:edit"
                                                            alternative-text="Edit Folder"
                                                            title="Edit Folder"
                                                            class="folder-comment-btn"
                                                            data-id={deg.id}
                                                            onclick={handleFolderCommentClick}>
                                                        </lightning-button-icon>
                                                    </template>

                                                    <template if:true={deg.displayDate}>
                                                        <span class="date-text">{deg.displayDate}</span>
                                                    </template>
                                                    <template if:true={deg.showStatus}>
                                                        <span class={deg.statusClass}>
                                                            <span class="status-dot"></span>
                                                            {deg.status}
                                                        </span>
                                                    </template>
                                                </div>
                                            </div>

                                            <!-- Level 3: Certificates / Marksheets folders under degree -->
                                            <template if:true={deg.expanded}>
                                                <template if:true={deg.children}>
                                                    <template for:each={deg.children} for:item="cat">
                                                        <div key={cat.id} class="row-wrapper">
                                                            <div class="row level-3-row row-hover" onclick={handleToggleFolder} data-id={cat.id}>
                                                                <div class="row-left level-3-indent">
                                                                    <div class="chevron">
                                                                        <template if:true={cat.expanded}>
                                                                            <lightning-icon icon-name="utility:chevrondown"
                                                                                            size="x-small"
                                                                                            alternative-text="Collapse">
                                                                            </lightning-icon>
                                                                        </template>
                                                                        <template if:false={cat.expanded}>
                                                                            <lightning-icon icon-name="utility:chevronright"
                                                                                            size="x-small"
                                                                                            alternative-text="Expand">
                                                                            </lightning-icon>
                                                                        </template>
                                                                    </div>
                                                                    <lightning-icon icon-name="utility:open_folder"
                                                                                    size="small"
                                                                                    class="folder-icon folder-icon-category">
                                                                    </lightning-icon>
                                                                    <div class="title-block">
                                                                        <div class="title">
                                                                            {cat.name}
                                                                        </div>
                                                                        <div class="subtitle">{cat.subtitle}</div>

                                                                        <template if:true={cat.statusSummary}>
                                                                            <div class="status-summary">
                                                                                {cat.statusSummary}
                                                                            </div>
                                                                        </template>

                                                                        <template if:true={cat.comments}>
                                                                            <div class="folder-comment">Comment: {cat.comments}</div>
                                                                        </template>
                                                                    </div>
                                                                </div>

                                                                <div class="row-right">
                                                                    <template if:true={cat.allowFolderEdit}>
                                                                        <lightning-button-icon
                                                                            icon-name="utility:edit"
                                                                            alternative-text="Edit Folder"
                                                                            title="Edit Folder"
                                                                            class="folder-comment-btn"
                                                                            data-id={cat.id}
                                                                            onclick={handleFolderCommentClick}>
                                                                        </lightning-button-icon>
                                                                    </template>

                                                                    <template if:true={cat.displayDate}>
                                                                        <span class="date-text">{cat.displayDate}</span>
                                                                    </template>
                                                                    <template if:true={cat.showStatus}>
                                                                        <span class={cat.statusClass}>
                                                                            <span class="status-dot"></span>
                                                                            {cat.status}
                                                                        </span>
                                                                    </template>
                                                                </div>
                                                            </div>

                                                            <!-- FILES UNDER CATEGORY -->
                                                            <template if:true={cat.expanded}>
                                                                <template if:true={cat.files}>
                                                                    <template for:each={cat.files} for:item="file">
                                                                        <div key={file.id} class="row file-row row-hover">
                                                                            <div class="row-left level-4-indent">
                                                                                <lightning-icon icon-name={file.iconName}
                                                                                                size="small"
                                                                                                class="file-icon">
                                                                                </lightning-icon>
                                                                                <div class="title-block">
                                                                                    <div class="title file-name">
                                                                                        {file.name}
                                                                                    </div>
                                                                                    <div class="subtitle">
                                                                                        {file.fileType} · {file.fileFormat}
                                                                                        <template if:true={file.percentage}>
                                                                                            · {file.percentage}% 
                                                                                        </template>
                                                                                        <template if:true={file.yearOfGraduation}>
                                                                                            · {file.yearOfGraduation}
                                                                                        </template>
                                                                                    </div>

                                                                                    <template if:true={file.comment}>
                                                                                        <div class="file-comment">Comment: {file.comment}</div>
                                                                                    </template>
                                                                                </div>
                                                                            </div>

                                                                            <div class="row-right">
                                                                                <lightning-button
                                                                                    variant="brand-outline"
                                                                                    label="View"
                                                                                    class="file-link view-button"
                                                                                    data-id={file.id}
                                                                                    onclick={handleViewFile}
                                                                                    disabled={file.isViewing}>
                                                                                </lightning-button>
                                                                                <template if:true={file.isViewing}>
                                                                                    <lightning-spinner alternative-text="Loading" size="small" class="view-spinner"></lightning-spinner>
                                                                                </template>

                                                                                <span class={file.statusClass}>
                                                                                    <span class="status-dot"></span>
                                                                                    {file.status}
                                                                                </span>

                                                                                <lightning-button-icon
                                                                                    icon-name="utility:edit"
                                                                                    alternative-text="Edit File"
                                                                                    title="Edit File"
                                                                                    class="file-edit-btn"
                                                                                    data-id={file.id}
                                                                                    onclick={handleEditFile}>
                                                                                </lightning-button-icon>
                                                                            </div>
                                                                        </div>
                                                                    </template>
                                                                </template>
                                                            </template>
                                                        </div>
                                                    </template>
                                                </template>
                                            </template>
                                        </div>
                                    </template>
                                </template>
                            </template>
                        </article>
                    </template>
                </div>

                <!-- <div class="footer-summary">
                    <div>Total files: {totalFilesOverall}</div>
                </div> -->
            </template>

            <template if:false={hasData}>
                <div class="loading-or-empty">
                    <template if:true={isLoading}>
                        <lightning-spinner alternative-text="Loading" size="medium"></lightning-spinner>
                    </template>
                    <template if:false={isLoading}>
                        <p>No data available.</p>
                    </template>
                </div>
            </template>
        </div>

        <!-- FILE EDIT MODAL -->
        <template if:true={isModalOpen}>
            <section role="dialog" tabindex="-1" aria-modal="true" class="slds-modal slds-fade-in-open">
                <div class="slds-modal__container">
                    <header class="slds-modal__header ler-modal-header">
                        <h2 class="slds-text-heading_medium">
                            Edit File – {editFile.name}
                        </h2>
                    </header>
                    <div class="slds-modal__content slds-p-around_medium">
                        <lightning-combobox
                            name="status"
                            label="Status"
                            value={editFile.status}
                            options={fileStatusOptionsForUi}
                            onchange={handleFieldChange}>
                        </lightning-combobox>

                        <lightning-textarea
                            name="comment"
                            label="Comment"
                            value={editFile.comment}
                            onchange={handleFieldChange}>
                        </lightning-textarea>
                    </div>
                    <footer class="slds-modal__footer">
                        <lightning-button variant="neutral" label="Cancel" onclick={closeModal}></lightning-button>
                        <lightning-button variant="brand" class="ler-btn-left_small" label="Save" onclick={saveFile}></lightning-button>
                    </footer>
                </div>
            </section>
            <div class="slds-backdrop slds-backdrop_open"></div>
        </template>

        <!-- FOLDER COMMENT / STATUS MODAL -->
        <template if:true={isFolderModalOpen}>
            <section role="dialog" tabindex="-1" aria-modal="true" class="slds-modal slds-fade-in-open">
                <div class="slds-modal__container">
                    <header class="slds-modal__header ler-modal-header">
                        <h2 class="slds-text-heading_medium">
                            Folder Review – {activeFolder.name}
                        </h2>
                    </header>
                    <div class="slds-modal__content slds-p-around_medium">
                        <lightning-combobox
                            name="folderStatus"
                            label="Folder Status"
                            value={activeFolder.status}
                            placeholder="Select Status"
                            options={folderStatusOptionsForUi}
                            onchange={handleFolderStatusChange}>
                        </lightning-combobox>

                        <lightning-textarea
                            name="folderComment"
                            label="Comment"
                            value={folderCommentText}
                            onchange={handleFolderCommentChange}>
                        </lightning-textarea>
                    </div>
                    <footer class="slds-modal__footer">
                        <lightning-button variant="neutral" label="Cancel" onclick={closeFolderModal}></lightning-button>
                        <lightning-button variant="brand" class="ler-btn-left_small" label="Save" onclick={saveFolderComment}></lightning-button>
                    </footer>
                </div>
            </section>
            <div class="slds-backdrop slds-backdrop_open"></div>
        </template>

        <!-- EDIT ELIGIBILITY MODAL -->
        <template if:true={isEditModalOpen}>
            <section role="dialog" tabindex="-1" aria-modal="true" class="slds-modal slds-fade-in-open">
                <div class="slds-modal__container">
                    <header class="slds-modal__header ler-modal-header">
                        <h2 class="slds-text-heading_medium">
                            Edit Eligibility Summary
                        </h2>
                    </header>
                    <div class="slds-modal__content slds-p-around_medium">
                        <lightning-input
                            name="editCreditScore"
                            type="number"
                            label="Credit Score"
                            value={editCreditScore}
                            onchange={handleEditFieldChange}>
                        </lightning-input>

                        <lightning-combobox
                            name="editCpaStatus"
                            label="CPA Eligibility Status"
                            value={editCpaStatus}
                            options={cpaStatusOptions}
                            onchange={handleEditFieldChange}>
                        </lightning-combobox>

                        <lightning-combobox
                            name="editLeadStatus"
                            label="Lead Eligibility Status"
                            value={editLeadStatus}
                            options={leadStatusOptionsForUi}
                            onchange={handleEditFieldChange}>
                        </lightning-combobox>
                    </div>
                    <footer class="slds-modal__footer">
                        <lightning-button variant="neutral" label="Cancel" onclick={closeEditModal}></lightning-button>
                        <lightning-button variant="brand" class="ler-btn-left_small" label="Save" onclick={saveEligibilitySnapshot}></lightning-button>
                    </footer>
                </div>
            </section>
            <div class="slds-backdrop slds-backdrop_open"></div>
        </template>
    </lightning-card>
</template>