<template>
    <lightning-card title="Eligibility File Verification" icon-name="custom:custom63">
        <!-- TOP PATH FOR GP LEAD STATUS (READ ONLY) -->
        <div class="ler-path-wrapper">
            <div class="path-label">Eligibility Status</div>
            <div class="path-steps">
                <template for:each={pathItems} for:item="step">
                    <div key={step.value} class={step.className}>
                        {step.label}
                    </div>
                </template>
            </div>
        </div>

        <div class="ler-container">
            <template if:true={hasData}>
                <!-- MESSAGE IF THERE ARE NO FILES ANYWHERE -->
                <template if:false={hasAnyFile}>
                    <div class="no-files-note">
                        No eligibility documents have been uploaded yet for this Lead.
                    </div>
                </template>

                <div class="root-list">
                    <template for:each={folderTree} for:item="root">
                        <article key={root.id} class="root-card">
                            <!-- ROOT ROW (UG / PG / Certificates) -->
                            <div class="row root-row row-hover" onclick={handleToggleFolder} data-id={root.id}>
                                <div class="row-left">
                                    <div class="chevron">
                                        <template if:true={root.expanded}>
                                            <lightning-icon icon-name="utility:chevrondown"
                                                            size="x-small"
                                                            alternative-text="Collapse">
                                            </lightning-icon>
                                        </template>
                                        <template if:false={root.expanded}>
                                            <lightning-icon icon-name="utility:chevronright"
                                                            size="x-small"
                                                            alternative-text="Expand">
                                            </lightning-icon>
                                        </template>
                                    </div>
                                    <lightning-icon icon-name="utility:open_folder"
                                                    size="small"
                                                    class="folder-icon folder-icon-root">
                                    </lightning-icon>
                                    <div class="title-block">
                                        <div class="title">
                                            {root.name}
                                        </div>
                                        <div class="subtitle">{root.subtitle}</div>

                                        <template if:true={root.statusSummary}>
                                            <div class="status-summary">
                                                {root.statusSummary}
                                            </div>
                                        </template>

                                        <template if:true={root.comments}>
                                            <div class="folder-comment">Comment: {root.comments}</div>
                                        </template>
                                    </div>
                                </div>

                                <div class="row-right">
                                    <lightning-button-icon
                                        icon-name="utility:edit"
                                        alternative-text="Add Comment"
                                        title="Add Comment"
                                        class="folder-comment-btn"
                                        data-id={root.id}
                                        onclick={handleFolderCommentClick}>
                                    </lightning-button-icon>

                                    <template if:true={root.displayDate}>
                                        <span class="date-text">{root.displayDate}</span>
                                    </template>
                                    <template if:true={root.showStatus}>
                                        <span class={root.statusClass}>
                                            <span class="status-dot"></span>
                                            {root.status}
                                        </span>
                                    </template>
                                </div>
                            </div>

                            <!-- ROOT CONTENT (DEGREES + FILES) -->
                            <template if:true={root.expanded}>
                                <!-- Level 2: Degrees under root -->
                                <template if:true={root.children}>
                                    <template for:each={root.children} for:item="deg">
                                        <div key={deg.id} class="row-wrapper">
                                            <!-- DEGREE ROW -->
                                            <div class="row level-2-row row-hover" onclick={handleToggleFolder} data-id={deg.id}>
                                                <div class="row-left level-2-indent">
                                                    <div class="chevron">
                                                        <template if:true={deg.expanded}>
                                                            <lightning-icon icon-name="utility:chevrondown"
                                                                            size="x-small"
                                                                            alternative-text="Collapse">
                                                            </lightning-icon>
                                                        </template>
                                                        <template if:false={deg.expanded}>
                                                            <lightning-icon icon-name="utility:chevronright"
                                                                            size="x-small"
                                                                            alternative-text="Expand">
                                                            </lightning-icon>
                                                        </template>
                                                    </div>
                                                    <lightning-icon icon-name="utility:open_folder"
                                                                    size="small"
                                                                    class="folder-icon folder-icon-degree">
                                                    </lightning-icon>
                                                    <div class="title-block">
                                                        <div class="title">
                                                            {deg.name}
                                                        </div>
                                                        <div class="subtitle">{deg.subtitle}</div>

                                                        <template if:true={deg.statusSummary}>
                                                            <div class="status-summary">
                                                                {deg.statusSummary}
                                                            </div>
                                                        </template>

                                                        <template if:true={deg.comments}>
                                                            <div class="folder-comment">Comment: {deg.comments}</div>
                                                        </template>
                                                    </div>
                                                </div>
                                                <div class="row-right">
                                                    <lightning-button-icon
                                                        icon-name="utility:edit"
                                                        alternative-text="Add Comment"
                                                        title="Add Comment"
                                                        class="folder-comment-btn"
                                                        data-id={deg.id}
                                                        onclick={handleFolderCommentClick}>
                                                    </lightning-button-icon>

                                                    <template if:true={deg.displayDate}>
                                                        <span class="date-text">{deg.displayDate}</span>
                                                    </template>
                                                    <template if:true={deg.showStatus}>
                                                        <span class={deg.statusClass}>
                                                            <span class="status-dot"></span>
                                                            {deg.status}
                                                        </span>
                                                    </template>
                                                </div>
                                            </div>

                                            <!-- DEGREE CONTENT -->
                                            <template if:true={deg.expanded}>

                                                <!-- Level 3: Category folders (Marksheet / Certificates) -->
                                                <template if:true={deg.children}>
                                                    <template for:each={deg.children} for:item="cat">
                                                        <div key={cat.id} class="row-wrapper">
                                                            <!-- CATEGORY ROW -->
                                                            <div class="row level-3-row row-hover" onclick={handleToggleFolder} data-id={cat.id}>
                                                                <div class="row-left level-3-indent">
                                                                    <div class="chevron">
                                                                        <template if:true={cat.expanded}>
                                                                            <lightning-icon icon-name="utility:chevrondown"
                                                                                            size="x-small"
                                                                                            alternative-text="Collapse">
                                                                            </lightning-icon>
                                                                        </template>
                                                                        <template if:false={cat.expanded}>
                                                                            <lightning-icon icon-name="utility:chevronright"
                                                                                            size="x-small"
                                                                                            alternative-text="Expand">
                                                                            </lightning-icon>
                                                                        </template>
                                                                    </div>
                                                                    <lightning-icon icon-name="utility:open_folder"
                                                                                    size="small"
                                                                                    class="folder-icon folder-icon-category">
                                                                    </lightning-icon>
                                                                    <div class="title-block">
                                                                        <div class="title">
                                                                            {cat.name}
                                                                        </div>
                                                                        <div class="subtitle">{cat.subtitle}</div>

                                                                        <template if:true={cat.statusSummary}>
                                                                            <div class="status-summary">
                                                                                {cat.statusSummary}
                                                                            </div>
                                                                        </template>

                                                                        <template if:true={cat.comments}>
                                                                            <div class="folder-comment">Comment: {cat.comments}</div>
                                                                        </template>
                                                                    </div>
                                                                </div>
                                                                <div class="row-right">
                                                                    <lightning-button-icon
                                                                        icon-name="utility:edit"
                                                                        alternative-text="Add Comment"
                                                                        title="Add Comment"
                                                                        class="folder-comment-btn"
                                                                        data-id={cat.id}
                                                                        onclick={handleFolderCommentClick}>
                                                                    </lightning-button-icon>

                                                                    <template if:true={cat.displayDate}>
                                                                        <span class="date-text">{cat.displayDate}</span>
                                                                    </template>
                                                                    <template if:true={cat.showStatus}>
                                                                        <span class={cat.statusClass}>
                                                                            <span class="status-dot"></span>
                                                                            {cat.status}
                                                                        </span>
                                                                    </template>
                                                                </div>
                                                            </div>

                                                            <!-- FILES UNDER CATEGORY -->
                                                            <template if:true={cat.expanded}>
                                                                <template if:true={cat.files}>
                                                                    <template for:each={cat.files} for:item="file">
                                                                        <div key={file.id} class="file-row level-4-row row-hover">
                                                                            <div class="file-left level-4-indent">
                                                                                <lightning-icon icon-name={file.iconName}
                                                                                                size="small"
                                                                                                class="file-icon">
                                                                                </lightning-icon>
                                                                                <div class="file-text">
                                                                                    <div class="file-name">{file.name}</div>
                                                                                    <div class="file-subtitle">
                                                                                        <template if:true={file.description}>
                                                                                            <span>{file.description}</span>
                                                                                        </template>
                                                                                    </div>
                                                                                    <div class="file-meta">
                                                                                        <template if:true={file.size}>
                                                                                            <span>{file.size}</span>
                                                                                        </template>
                                                                                        <template if:true={file.uploadedOn}>
                                                                                            <span>Modified: {file.uploadedOn}</span>
                                                                                        </template>
                                                                                        <template if:true={file.uploadedBy}>
                                                                                            <span>By: {file.uploadedBy}</span>
                                                                                        </template>
                                                                                    </div>

                                                                                    <template if:true={file.comment}>
                                                                                        <div class="file-comment">
                                                                                            Comment: {file.comment}
                                                                                        </div>
                                                                                    </template>

                                                                                    <!-- INLINE "ROW" TABLE OF FILE DATA -->
                                                                                    <div class="file-table">
                                                                                        <div class="file-table-cell">
                                                                                            <span class="file-field-label">Percentage</span>
                                                                                            <span class="file-field-value">
                                                                                                <template if:true={file.percentage}>{file.percentage}</template>
                                                                                                <template if:false={file.percentage}>-</template>
                                                                                            </span>
                                                                                        </div>
                                                                                        <div class="file-table-cell">
                                                                                            <span class="file-field-label">Year</span>
                                                                                            <span class="file-field-value">
                                                                                                <template if:true={file.yearOfGraduation}>{file.yearOfGraduation}</template>
                                                                                                <template if:false={file.yearOfGraduation}>-</template>
                                                                                            </span>
                                                                                        </div>
                                                                                        <div class="file-table-cell">
                                                                                            <span class="file-field-label">Grade</span>
                                                                                            <span class="file-field-value">
                                                                                                <template if:true={file.grade}>{file.grade}</template>
                                                                                                <template if:false={file.grade}>-</template>
                                                                                            </span>
                                                                                        </div>
                                                                                        <div class="file-table-cell">
                                                                                            <span class="file-field-label">Rank / Div</span>
                                                                                            <span class="file-field-value">
                                                                                                <template if:true={file.rankDivision}>{file.rankDivision}</template>
                                                                                                <template if:false={file.rankDivision}>-</template>
                                                                                            </span>
                                                                                        </div>
                                                                                        <div class="file-table-cell">
                                                                                            <span class="file-field-label">University</span>
                                                                                            <span class="file-field-value">
                                                                                                <template if:true={file.university}>{file.university}</template>
                                                                                                <template if:false={file.university}>-</template>
                                                                                            </span>
                                                                                        </div>
                                                                                    </div>
                                                                                </div>
                                                                            </div>

                                                                            <div class="file-right">
                                                                                <span class={file.statusClass}>
                                                                                    <span class="status-dot"></span>
                                                                                    {file.status}
                                                                                </span>

                                                                                <lightning-button
                                                                                    variant="neutral"
                                                                                    label="View"
                                                                                    title="View File"
                                                                                    class="slds-m-left_small"
                                                                                    data-id={file.id}
                                                                                    onclick={handleViewFile}>
                                                                                </lightning-button>

                                                                                <lightning-button
                                                                                    variant="brand-outline"
                                                                                    label="Edit"
                                                                                    title="Edit File"
                                                                                    class="slds-m-left_small"
                                                                                    data-id={file.id}
                                                                                    onclick={handleEditFile}>
                                                                                </lightning-button>
                                                                            </div>
                                                                        </div>
                                                                    </template>
                                                                </template>
                                                            </template>
                                                        </div>
                                                    </template>
                                                </template>

                                                <!-- Files directly under degree (rare but supported) -->
                                                <template if:true={deg.files}>
                                                    <template for:each={deg.files} for:item="dfile">
                                                        <div key={dfile.id} class="file-row level-3-row row-hover">
                                                            <div class="file-left level-3-indent">
                                                                <lightning-icon icon-name={dfile.iconName}
                                                                                size="small"
                                                                                class="file-icon">
                                                                </lightning-icon>
                                                                <div class="file-text">
                                                                    <div class="file-name">{dfile.name}</div>
                                                                    <div class="file-subtitle">
                                                                        <template if:true={dfile.description}>
                                                                            <span>{dfile.description}</span>
                                                                        </template>
                                                                    </div>
                                                                    <div class="file-meta">
                                                                        <template if:true={dfile.size}>
                                                                            <span>{dfile.size}</span>
                                                                        </template>
                                                                        <template if:true={dfile.uploadedOn}>
                                                                            <span>Modified: {dfile.uploadedOn}</span>
                                                                        </template>
                                                                        <template if:true={dfile.uploadedBy}>
                                                                            <span>By: {dfile.uploadedBy}</span>
                                                                        </template>
                                                                    </div>

                                                                    <template if:true={dfile.comment}>
                                                                        <div class="file-comment">
                                                                            Comment: {dfile.comment}
                                                                        </div>
                                                                    </template>

                                                                    <div class="file-table">
                                                                        <div class="file-table-cell">
                                                                            <span class="file-field-label">Percentage</span>
                                                                            <span class="file-field-value">
                                                                                <template if:true={dfile.percentage}>{dfile.percentage}</template>
                                                                                <template if:false={dfile.percentage}>-</template>
                                                                            </span>
                                                                        </div>
                                                                        <div class="file-table-cell">
                                                                            <span class="file-field-label">Year</span>
                                                                            <span class="file-field-value">
                                                                                <template if:true={dfile.yearOfGraduation}>{dfile.yearOfGraduation}</template>
                                                                                <template if:false={dfile.yearOfGraduation}>-</template>
                                                                            </span>
                                                                        </div>
                                                                        <div class="file-table-cell">
                                                                            <span class="file-field-label">Grade</span>
                                                                            <span class="file-field-value">
                                                                                <template if:true={dfile.grade}>{dfile.grade}</template>
                                                                                <template if:false={dfile.grade}>-</template>
                                                                            </span>
                                                                        </div>
                                                                        <div class="file-table-cell">
                                                                            <span class="file-field-label">Rank / Div</span>
                                                                            <span class="file-field-value">
                                                                                <template if:true={dfile.rankDivision}>{dfile.rankDivision}</template>
                                                                                <template if:false={dfile.rankDivision}>-</template>
                                                                            </span>
                                                                        </div>
                                                                        <div class="file-table-cell">
                                                                            <span class="file-field-label">University</span>
                                                                            <span class="file-field-value">
                                                                                <template if:true={dfile.university}>{dfile.university}</template>
                                                                                <template if:false={dfile.university}>-</template>
                                                                            </span>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div class="file-right">
                                                                <span class={dfile.statusClass}>
                                                                    <span class="status-dot"></span>
                                                                    {dfile.status}
                                                                </span>
                                                                <lightning-button
                                                                    variant="neutral"
                                                                    label="View"
                                                                    class="slds-m-left_small"
                                                                    data-id={dfile.id}
                                                                    onclick={handleViewFile}>
                                                                </lightning-button>
                                                                <lightning-button
                                                                    variant="brand-outline"
                                                                    label="Edit"
                                                                    class="slds-m-left_small"
                                                                    data-id={dfile.id}
                                                                    onclick={handleEditFile}>
                                                                </lightning-button>
                                                            </div>
                                                        </div>
                                                    </template>
                                                </template>

                                            </template>
                                        </div>
                                    </template>
                                </template>

                                <!-- Files directly under root (if any) -->
                                <template if:true={root.files}>
                                    <template for:each={root.files} for:item="rfile">
                                        <div key={rfile.id} class="file-row level-2-row row-hover">
                                            <div class="file-left level-2-indent">
                                                <lightning-icon icon-name={rfile.iconName}
                                                                size="small"
                                                                class="file-icon">
                                                </lightning-icon>
                                                <div class="file-text">
                                                    <div class="file-name">{rfile.name}</div>
                                                    <div class="file-subtitle">
                                                        <template if:true={rfile.description}>
                                                            <span>{rfile.description}</span>
                                                        </template>
                                                    </div>
                                                    <div class="file-meta">
                                                        <template if:true={rfile.size}>
                                                            <span>{rfile.size}</span>
                                                        </template>
                                                        <template if:true={rfile.uploadedOn}>
                                                            <span>Modified: {rfile.uploadedOn}</span>
                                                        </template>
                                                        <template if:true={rfile.uploadedBy}>
                                                            <span>By: {rfile.uploadedBy}</span>
                                                        </template>
                                                    </div>

                                                    <template if:true={rfile.comment}>
                                                        <div class="file-comment">
                                                            Comment: {rfile.comment}
                                                        </div>
                                                    </template>

                                                    <div class="file-table">
                                                        <div class="file-table-cell">
                                                            <span class="file-field-label">Percentage</span>
                                                            <span class="file-field-value">
                                                                <template if:true={rfile.percentage}>{rfile.percentage}</template>
                                                                <template if:false={rfile.percentage}>-</template>
                                                            </span>
                                                        </div>
                                                        <div class="file-table-cell">
                                                            <span class="file-field-label">Year</span>
                                                            <span class="file-field-value">
                                                                <template if:true={rfile.yearOfGraduation}>{rfile.yearOfGraduation}</template>
                                                                <template if:false={rfile.yearOfGraduation}>-</template>
                                                            </span>
                                                        </div>
                                                        <div class="file-table-cell">
                                                            <span class="file-field-label">Grade</span>
                                                            <span class="file-field-value">
                                                                <template if:true={rfile.grade}>{rfile.grade}</template>
                                                                <template if:false={rfile.grade}>-</template>
                                                            </span>
                                                        </div>
                                                        <div class="file-table-cell">
                                                            <span class="file-field-label">Rank / Div</span>
                                                            <span class="file-field-value">
                                                                <template if:true={rfile.rankDivision}>{rfile.rankDivision}</template>
                                                                <template if:false={rfile.rankDivision}>-</template>
                                                            </span>
                                                        </div>
                                                        <div class="file-table-cell">
                                                            <span class="file-field-label">University</span>
                                                            <span class="file-field-value">
                                                                <template if:true={rfile.university}>{rfile.university}</template>
                                                                <template if:false={rfile.university}>-</template>
                                                            </span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="file-right">
                                                <span class={rfile.statusClass}>
                                                    <span class="status-dot"></span>
                                                    {rfile.status}
                                                </span>
                                                <lightning-button
                                                    variant="neutral"
                                                    label="View"
                                                    class="slds-m-left_small"
                                                    data-id={rfile.id}
                                                    onclick={handleViewFile}>
                                                </lightning-button>
                                                <lightning-button
                                                    variant="brand-outline"
                                                    label="Edit"
                                                    class="slds-m-left_small"
                                                    data-id={rfile.id}
                                                    onclick={handleEditFile}>
                                                </lightning-button>
                                            </div>
                                        </div>
                                    </template>
                                </template>

                            </template>
                        </article>
                    </template>
                </div>
            </template>

            <template if:false={hasData}>
                <div class="slds-p-around_medium slds-text-color_weak">
                    No eligibility folders found for this Lead.
                </div>
            </template>
        </div>

        <!-- EDIT FILE MODAL -->
        <template if:true={isModalOpen}>
            <section role="dialog" tabindex="-1" aria-modal="true" class="slds-modal slds-fade-in-open">
                <div class="slds-modal__container">
                    <header class="slds-modal__header ler-modal-header">
                        <h2 class="slds-text-heading_medium">
                            Edit File – {editFile.name}
                        </h2>
                    </header>
                    <div class="slds-modal__content slds-p-around_medium">
                        <lightning-input
                            type="text"
                            label="File Name"
                            value={editFile.name}
                            disabled>
                        </lightning-input>

                        <lightning-combobox
                            class="slds-m-top_small"
                            label="Status"
                            name="status"
                            value={editFile.status}
                            options={statusOptions}
                            onchange={handleFieldChange}>
                        </lightning-combobox>

                        <template if:true={showCommentField}>
                            <lightning-textarea
                                class="slds-m-top_small"
                                name="comment"
                                label="Comment"
                                value={editFile.comment}
                                onchange={handleFieldChange}>
                            </lightning-textarea>
                        </template>
                    </div>

                    <footer class="slds-modal__footer">
                        <lightning-button variant="neutral" label="Cancel" onclick={closeModal}></lightning-button>
                        <lightning-button variant="brand" class="slds-m-left_small" label="Save" onclick={saveFile}></lightning-button>
                    </footer>
                </div>
            </section>
            <div class="slds-backdrop slds-backdrop_open"></div>
        </template>

        <!-- FOLDER COMMENT MODAL -->
        <template if:true={isFolderModalOpen}>
            <section role="dialog" tabindex="-1" aria-modal="true" class="slds-modal slds-fade-in-open">
                <div class="slds-modal__container">
                    <header class="slds-modal__header ler-modal-header">
                        <h2 class="slds-text-heading_medium">
                            Folder Comment – {activeFolder.name}
                        </h2>
                    </header>
                    <div class="slds-modal__content slds-p-around_medium">
                        <lightning-textarea
                            name="folderComment"
                            label="Comment"
                            value={folderCommentText}
                            onchange={handleFolderCommentChange}>
                        </lightning-textarea>
                    </div>
                    <footer class="slds-modal__footer">
                        <lightning-button variant="neutral" label="Cancel" onclick={closeFolderModal}></lightning-button>
                        <lightning-button variant="brand" class="slds-m-left_small" label="Save" onclick={saveFolderComment}></lightning-button>
                    </footer>
                </div>
            </section>
            <div class="slds-backdrop slds-backdrop_open"></div>
        </template>
    </lightning-card>
</template>