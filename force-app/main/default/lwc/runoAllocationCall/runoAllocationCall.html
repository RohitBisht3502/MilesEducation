<template>
  <lightning-quick-action-panel header="" class="panel-wrapper">

    <!-- CUSTOM HEADER -->
    <div class="custom-header">
        <div class="header-left">
            <lightning-icon icon-name="utility:call" size="small"></lightning-icon>
            <span class="header-title">{callTitle}</span>
        </div>

        <div class="header-right">
            <span class="status-pill">{callStatus}</span>
            <span class="duration">
                <lightning-icon icon-name="utility:clock" size="x-small"></lightning-icon>
                {elapsedLabel}
            </span>
        </div>
    </div>



        <!-- LOADING STATE -->
        <template if:true={loading}>
            <div class="loading-state">
                <lightning-spinner alternative-text="Sending..." size="small"></lightning-spinner>
                <div class="loading-text">Calling Runo Allocation APIâ€¦</div>
            </div>
        </template>

        <!-- CALL POPUP OVERLAY -->
        <template if:true={showCallPopup}>
            <div class="call-overlay">
                <div class="popup-inner wave-container">
                    <div class="popup-call-icon pulse-icon">
                        <lightning-icon icon-name="utility:call" size="large"></lightning-icon>
                    </div>

                    <div class="popup-text">Calling Runo...</div>

                    <div class="wave-loader">
                        <span></span><span></span><span></span><span></span>
                    </div>

                    <!-- END CALL BUTTON (AFTER 30s NO RESPONSE) -->
                    <template if:true={canEndCall}>
                        <div class="slds-m-top_medium">
                            <lightning-button
                                variant="destructive"
                                label="End Call"
                                onclick={handleEndCall}>
                            </lightning-button>
                        </div>
                    </template>
                </div>
            </div>
        </template>

        <!-- ERROR -->
        <template if:true={errorText}>
            <div class="error-box">
                <div class="error-inner">
                    <lightning-icon icon-name="utility:error" size="x-small" class="error-icon"></lightning-icon>
                    <div class="error-message">{errorText}</div>
                </div>
            </div>
        </template>

        <!-- BODY -->
        <div class="body-wrapper">

            <div class="slds-grid slds-gutters slds-wrap">

    <!-- LEFT : LEAD INFO -->
    <div class="slds-col slds-size_1-of-1 slds-large-size_1-of-2">
        <div class="section-card">
            <div class="section-header">
                <lightning-icon icon-name="standard:lead" size="small"></lightning-icon>
                <span>Lead Information</span>
            </div>

            <!-- 2x2 GRID -->
            <div class="info-grid">

                <div class="info-tile">
                    <lightning-icon icon-name="utility:user"></lightning-icon>
                    <div>
                        <small>Name:-</small>
                        <strong>{identity.name}</strong>
                    </div>
                </div>

                <div class="info-tile">
                    <lightning-icon icon-name="utility:location"></lightning-icon>
                    <div>
                        <small>Location:-</small>
                        <strong>{identity.city}</strong>
                    </div>
                </div>

                <div class="info-tile">
                    <lightning-icon icon-name="utility:topic"></lightning-icon>
                    <div>
                        <small>Course:-</small>
                        <strong>{identity.source}</strong>
                    </div>
                </div>

                <div class="info-tile">
                    <lightning-icon icon-name="utility:collection"></lightning-icon>
                    <div>
                        <small>Stage :-</small>
                        <strong>{identity.stage}</strong>
                    </div>
                </div>

                <template if:true={identity.canId}>
                    <div class="info-tile">
                        <lightning-icon icon-name="utility:tag"></lightning-icon>
                        <div>
                            <small>CAN ID :-</small>
                            <strong>{identity.canId}</strong>
                        </div>
                    </div>
                </template>

<template if:true={showPopup}>
                <div class="call-popup">
                    Call Successfully sent
                </div>
            </template>
            </div>
        </div>

        <div class="section-card">
            <div class="section-header">
                <lightning-icon icon-name="utility:call" size="small"></lightning-icon>
                <span>Call History</span>
            </div>

            <template if:true={hasCallHistory}>
                <div class="call-history-list">
                    <template for:each={callHistory} for:item="row">
                        <div class="call-history-item" key={row.id}>
                            <div class="call-history-left">
                                <div class="call-history-date">{row.dateLabel}</div>
                                <div class="call-history-time">{row.timeLabel}</div>
                            </div>
                            <div class="call-history-right">
                                <div class="call-history-duration">{row.durationLabel}</div>
                                <div class="call-history-status">{row.status}</div>
                            </div>
                            <div class="call-history-meta">
                                <span>{row.l1}</span>
                                <span>{row.l2}</span>
                                <span>{row.stage}</span>
                            </div>
                        </div>
                    </template>
                </div>
            </template>

            <template if:false={hasCallHistory}>
                <div class="call-history-empty">No call history found.</div>
            </template>
        </div>
    </div>

    <!-- RIGHT : CALL FEEDBACK -->
    <div class="slds-col slds-size_1-of-1 slds-large-size_1-of-2">

        <template if:true={showFeedback}>
            <div class="section-card">
                <div class="section-header">
                    <lightning-icon icon-name="utility:feedback" size="small"></lightning-icon>
                    <span>Call Feedback</span>
                </div>

                <div class="section-content slds-grid slds-wrap slds-gutters">
                    <!-- L1 -->
                    <div class="slds-col slds-size_1-of-2">
                        <lightning-combobox
                            label="Call Status (L1)"
                            value={l1Value}
                            options={l1Options}
                            onchange={handleL1Change}>
                        </lightning-combobox>
                    </div>

                    <!-- L2 -->
                    <div class="slds-col slds-size_1-of-2">
                        <lightning-combobox
                            label="Sub Status (L2)"
                            value={l2Value}
                            options={l2Options}
                            onchange={handleL2Change}
                            disabled={isL2Disabled}>
                        </lightning-combobox>
                    </div>

                    <div class="slds-col slds-size_1-of-1 slds-large-size_1-of-2 slds-m-top_small">
  <lightning-combobox
    class="text-color"
    name="stage"
    label="Stage"
    value={stageValue}
    options={stageOptions}
    onchange={handleStageChange}
    disabled={isStageDisabled}>
  </lightning-combobox>
</div>
<template if:true={isStageDisabled}>
 <div class="slds-text-color_weak slds-m-top_x-small stage-section">
    Stage not applicable for Not-Connected calls
  </div>
</template>

                    <!-- Comment -->
                    <div class="slds-col slds-size_1-of-1">
                        <lightning-textarea
                            label="Feedback Comment"
                            value={feedback}
                            onchange={handleFeedbackChange}
                            required={isCommentMandatory}>
                        </lightning-textarea>
                    </div>

                    <!-- Follow up -->
                    <div class="slds-col slds-size_1-of-1">
                        <lightning-input
                            type="datetime-local"
                            label="Next Follow Up"
                            value={nextFollowUpDate}
                            onchange={handleNextFollowUpDateChange}
                            disabled={autoSetFollowUp}>
                        </lightning-input>
                    </div>

                    <!-- Checkbox -->
                    <div class="slds-col slds-size_1-of-1 slds-m-top_small">
                        <lightning-input
                            type="checkbox"
                            label="Auto set next follow up (+24 hrs)"
                            checked={autoSetFollowUp}
                            onchange={handleAutoSetChange}>
                        </lightning-input>
                    </div>

                </div>
            </div>
        </template>

    </div>
</div>
</div> 


        <!-- FOOTER BUTTONS -->
        <div slot="footer" class="footer-actions">
          
            <!-- <lightning-button
                variant="neutral"
                label="Close"
                onclick={close}
                disabled={disableCancel}>
            </lightning-button> -->

            <template if:true={showFeedback}>
                <lightning-button
                    class="call-btn"
                    variant="brand"
                    label="Save Feedback"
                    onclick={saveFeedback}
                    disabled={isSaveDisabled}>
                </lightning-button>
            </template>

            <template if:false={showFeedback}>
                <lightning-button
                    class="call-btn"
                    data-id="callBtn"
                    variant="brand"
                    label={callButtonLabel}
                    onclick={callApi}
                    disabled={callButtonDisabled}>
                </lightning-button>
            </template>
            
        </div>

    </lightning-quick-action-panel>
</template>
