<template>
  <div class="wrap">
    <div class="toolbar">
      <!-- City -->
      <div class="filter">
        <label>City</label>
        <select class="city-select" onchange={onCityChange} value={selectedCity}>
          <option value="">Select</option>
          <template for:each={cities} for:item="c">
            <option key={c} value={c}>{c}</option>
          </template>
        </select>
      </div>

      <!-- Bucket -->
      <div class="filter">
        <label>Bucket</label>
        <select class="bucket-select" onchange={onBucketChange} value={selectedBucket}>
          <option value="">Select Bucket</option>
          <template for:each={buckets} for:item="b">
            <option key={b} value={b}>{b}</option>
          </template>
        </select>
      </div>

      <!-- Lead Sources -->
      <div class="filter">
        <label>Lead Sources</label>
        <div
  class="multiselect-trigger"
  onclick={openModal}
  data-disabled={isSourceDisabled}
  title={sourceTriggerTitle}
>
  <span class="ms-text">{selectedSourcesDisplay}</span>
  <span class="ms-caret">▾</span>

  <template if:true={selectedBucket}>
    <div class="bucket-hint">(From: {selectedBucket})</div>
  </template>
</div>

      </div>


      <div class="filter">
        <label>Type</label>
        <select onchange={onTypeChange}>
          <option value="">Select</option>
          <template for:each={typeOptions} for:item="t">
            <option key={t.value} value={t.value} selected={t.selected}>{t.label}</option>
          </template>
        </select>
      </div>


      <!-- Business Vertical (no logic for now) -->
      <!-- Business Vertical -->
      <!-- Business Vertical -->
      <div class="filter">
        <label>Business Vertical</label>
        <select onchange={onBusinessVerticalChange}>
          <option value="">Select</option>
          <template for:each={businessVerticalOptions} for:item="bv">
            <option key={bv.value} value={bv.value} selected={bv.selected}>{bv.label}</option>
          </template>
        </select>
      </div>
    

<div class="filter">
  <label>Role</label>
  <select onchange={handleRoleChange}>
    <option value="">Select</option>
    <template for:each={roleOptions} for:item="r">
      <option
        key={r.value}
        value={r.value}
        selected={r.selected}>
        {r.label}
      </option>
    </template>
  </select>
</div>







      <!-- Actions (✅ Removed New button) -->
      <div class="actions">
          <button class="btn small" onclick={openRoundRobinModal}>
       ON/OFF
    </button>
        <button class="btn small" onclick={reload}>Apply Filter</button>
        <button class="btn small" onclick={saveEdits}>Save</button>
        <button class="btn small ghost" onclick={clearFilters}>Clear Filter</button>
      </div>
    </div>

    <!-- Lead Sources Modal -->
    <template if:true={showModal}>
      <div class="modal-overlay" onclick={closeModal}>
        <div class="modal-content" onclick={handleModalClick}>
          <div class="modal-header">
            <h3>Select Lead Sources</h3>
            <button class="modal-close" onclick={closeModal}>X</button>
          </div>

          <div class="modal-body">
            <div class="multiselect-options">
              <template for:each={displayLeadSourcesTemp} for:item="s">
                <label key={s.key} class="option-label">
                  <input type="checkbox" data-value={s.value} checked={s.checked} onchange={handleCheckboxChange} />
                  <span>{s.label}</span>
                </label>
              </template>
            </div>
          </div>

          <div class="modal-footer">
            <button class="btn small" onclick={applySelection}>Apply</button>
            <button class="btn small ghost" onclick={closeModal}>Cancel</button>
          </div>
        </div>
      </div>
    </template>

    <template if:true={showRoundRobinModal}>
  <div class="modal-overlay" onclick={closeRoundRobinModal}>
    <div class="modal-content rr-modal" onclick={handleModalClick}>
      <div class="modal-header">
        <h3>Round Robin Settings</h3>
        <button class="modal-close" onclick={closeRoundRobinModal}>✕</button>
      </div>

      <div class="modal-body">
        <template for:each={roundRobinCities} for:item="city">
          <div key={city.name} class="rr-row">
            <div class="rr-city">
              <span class="city-name">{city.name}</span>
              <span class="rep-count">{city.count} sales reps</span>
            </div>

            <label class="switch">
              <input
                type="checkbox"
                checked={city.enabled}
                data-city={city.name}
                onchange={toggleCityRoundRobin}
              />
              <span class="slider"></span>
            </label>
          </div>
        </template>
      </div>

      <div class="modal-footer">
        <button class="btn small" onclick={applyRoundRobinSettings}>
          Done
        </button>
      </div>
    </div>
  </div>
</template>


    <!-- Sequence Modal -->
    <template if:true={showSeqModal}>
      <div class="modal-overlay" onclick={closeSeqModal}>
        <div class="modal-content" onclick={handleModalClick}>
          <div class="modal-header">
            <h3>Edit Sequence - {seqColLabel}</h3>
            <button class="modal-close" onclick={closeSeqModal}>X</button>
          </div>

          <div class="modal-body">
            <table class="matrix">
              <thead>
                <tr>
                  <th>Sales Rep</th>
                  <th>Sequence</th>
                  <!-- <th>Action</th> -->
                </tr>
              </thead>
              <tbody>
                <template for:each={seqRows} for:item="r" for:index="index">
                  <tr key={r.poolId}>
                    <td>{r.salesRepName}</td>
                    <td>
                      <input type="number" min="1" step="1" value={r.sequence} data-poolid={r.poolId}
                        oninput={onSeqInputChange} />
                    </td>
                    <!-- <td>
                      <button class="seq-btn" data-index={index} onclick={moveSeqUp} title="Move Up">⬆</button>
                      <button class="seq-btn" data-index={index} onclick={moveSeqDown} title="Move Down">⬇</button>
                    </td> -->
                  </tr>
                </template>
              </tbody>
            </table>
          </div>

          <div class="modal-footer">
            <button class="btn small" onclick={saveSeqEdits}>Save</button>
            <button class="btn small ghost" onclick={closeSeqModal}>Cancel</button>
          </div>
        </div>
      </div>
    </template>

    <!-- Matrix -->
    <div class="table-scroller">
      <table class="matrix">
        <thead>
          <tr>
            <th>Sales Rep Name</th>
            <template for:each={columns} for:item="col">
              <th key={col}>
               <span class="th-wrap">
  <span class="col-text">{col}</span>
  <button class="icon-btn" data-ci={col} onclick={openSeqModal} title="Edit sequence">✏️</button>
</span>

              </th>
            </template>
          </tr>
        </thead>

        <tbody>
          <template if:true={displayRows.length}>
            <template for:each={displayRows} for:item="row">
              <tr key={row.key}>
                <td>{row.salesRepName}</td>
                <template for:each={row.cells} for:item="cell">
                  <td key={cell.key}>
                    <span class="editable-cell" contenteditable="true" data-poolid={cell.poolId}
                      data-repid={row.salesRepId} data-src={cell.src} onblur={onCellBlur} onkeydown={onCellKeydown}
                      title="Enter weight">
                      {cell.value}
                    </span>
                  </td>
                </template>
              </tr>
            </template>
          </template>

          <template if:false={displayRows.length}>
            <tr>
              <td colspan={colspan} class="no-data">No data found</td>
            </tr>
          </template>
        </tbody>

        <tfoot>
          <tr>
            <th>Total</th>
            <template for:each={columnTotals} for:item="t">
              <th key={t} class="col-total">{t}</th>
            </template>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>

  <c-new-round-robin-adder onsuccess={loadMatrix}></c-new-round-robin-adder>
</template>