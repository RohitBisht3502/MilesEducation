<template>
  <lightning-quick-action-panel header="" class="panel-wrapper">

    <div class="custom-header">
      <div class="header-left">
        <lightning-icon icon-name="utility:call" size="small"></lightning-icon>
        <span class="header-title">{callTitle}</span>
      </div>

      <div class="header-right">
        <span class="status-pill">{callStatus}</span>
        <span class="duration">
          <lightning-icon icon-name="utility:clock" size="x-small"></lightning-icon>
          {elapsedLabel}
        </span>
      </div>
    </div>

    <template if:true={loading}>
      <div class="loading-state">
        <lightning-spinner alternative-text="Sending..." size="small"></lightning-spinner>
        <div class="loading-text">Calling Runo Allocation API...</div>
      </div>
    </template>

    <template if:true={showCallPopup}>
      <div class="call-overlay">
        <div class="popup-inner wave-container">
          <div class="popup-call-icon pulse-icon">
            <lightning-icon icon-name="utility:call" size="large"></lightning-icon>
          </div>

          <div class="popup-text">Calling Runo...</div>

          <div class="wave-loader">
            <span></span><span></span><span></span><span></span>
          </div>

          <template if:true={canEndCall}>
            <div class="slds-m-top_medium">
              <lightning-button
                variant="destructive"
                label="End Call"
                onclick={handleEndCall}>
              </lightning-button>
            </div>
          </template>
        </div>
      </div>
    </template>

    <template if:true={errorText}>
      <div class="error-box">
        <div class="error-inner">
          <lightning-icon icon-name="utility:error" size="x-small" class="error-icon"></lightning-icon>
          <div class="error-message">{errorText}</div>
        </div>
      </div>
    </template>

    <div class="body-wrapper content-grid">
      <div class="slds-grid slds-gutters slds-wrap">

        <div class="slds-col slds-size_1-of-1 slds-large-size_1-of-2">
          <div class="section-card">
            <div class="section-header">
              <lightning-icon icon-name="standard:lead" size="small"></lightning-icon>
              <span>Lead Information</span>
            </div>

            <div class="info-grid">
              <div class="info-tile">
                <lightning-icon icon-name="utility:user"></lightning-icon>
                <div>
                  <small>Name:-</small>
                  <strong>{identity.name}</strong>
                </div>
              </div>

              <div class="info-tile">
                <lightning-icon icon-name="utility:location"></lightning-icon>
                <div>
                  <small>Location:-</small>
                  <strong>{identity.city}</strong>
                </div>
              </div>

              <div class="info-tile">
                <lightning-icon icon-name="utility:topic"></lightning-icon>
                <div>
                  <small>Company:-</small>
                  <strong>{identity.source}</strong>
                </div>
              </div>

              <div class="info-tile">
                <lightning-icon icon-name="utility:collection"></lightning-icon>
                <div>
                  <small>Stage :-</small>
                  <strong>{identity.stage}</strong>
                </div>
              </div>

              <template if:true={showPopup}>
                <div class="call-popup">Call Successfully sent</div>
              </template>
            </div>
          </div>
        </div>

        <div class="slds-col slds-size_1-of-1 slds-large-size_1-of-2">
          <template if:true={showFeedback}>
            <div class="section-card">
              <div class="section-header">
                <lightning-icon icon-name="utility:feedback" size="small"></lightning-icon>
                <span>Call Feedback</span>
              </div>

              <div class="section-content slds-grid slds-wrap slds-gutters">
                <div class="slds-col slds-size_1-of-2">
                  <lightning-combobox
                    label="Call Status (L1)"
                    value={l1Value}
                    options={l1Options}
                    onchange={handleL1Change}>
                  </lightning-combobox>
                </div>

                <div class="slds-col slds-size_1-of-2">
                  <lightning-combobox
                    label="Sub Status (L2)"
                    value={l2Value}
                    options={l2Options}
                    onchange={handleL2Change}
                    disabled={isL2Disabled}>
                  </lightning-combobox>
                </div>

                <div class="slds-col slds-size_1-of-1 slds-large-size_1-of-2 slds-m-top_small">
                  <lightning-combobox
                    class="text-color"
                    name="stage"
                    label="Stage"
                    value={stageValue}
                    options={stageOptions}
                    onchange={handleStageChange}
                    disabled={isStageDisabled}>
                  </lightning-combobox>
                </div>

                <div class="slds-col slds-size_1-of-1 slds-large-size_1-of-2 slds-m-top_small">
                  <lightning-input
                    type="checkbox"
                    label="Notify Me"
                    checked={notifyMe}
                    onchange={handleNotifyChange}>
                  </lightning-input>
                </div>

                <template if:true={isStageDisabled}>
                  <div class="slds-text-color_weak slds-m-top_x-small stage-section">
                    Stage not applicable for Not-Connected calls
                  </div>
                </template>

                <div class="slds-col slds-size_1-of-1 feedback-followup-grid">
                  <div>
                    <lightning-textarea
                      label="Feedback Comment"
                      value={feedback}
                      onchange={handleFeedbackChange}
                      required={isCommentMandatory}>
                    </lightning-textarea>
                  </div>

                  <div>
                    <lightning-input
                      type="datetime-local"
                      label="Next Follow Up"
                      value={nextFollowUpDate}
                      onchange={handleNextFollowUpDateChange}
                      disabled={autoSetFollowUp}>
                    </lightning-input>

                    <div class="slds-m-top_small">
                      <lightning-input
                        type="checkbox"
                        label="Auto set next follow up (+24 hrs)"
                        checked={autoSetFollowUp}
                        onchange={handleAutoSetChange}>
                      </lightning-input>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </template>
        </div>
      </div>
    </div>

    <div slot="footer" class="footer-actions">
      <lightning-button
        class="footer-btn"
        variant="neutral"
        label="Save Disposition"
        onclick={saveFeedback}
        disabled={disableSaveDispositionBtn}>
      </lightning-button>

      <lightning-button
        class="footer-btn"
        variant="neutral"
        label="Save & Pause"
        onclick={handlePauseQueue}
        disabled={isQueuePaused}>
      </lightning-button>
    </div>

  </lightning-quick-action-panel>
</template>
