<template>
  <lightning-quick-action-panel header="" class="panel-wrapper">

    <div class="custom-header">
      <div class="header-left">
        <lightning-icon icon-name="utility:call" size="small"></lightning-icon>
        <span class="header-title">{callTitle}</span>
      </div>

      <div class="header-right">
        <span class="status-pill">{callStatus}</span>
        <span class="duration">
          <lightning-icon icon-name="utility:clock" size="x-small"></lightning-icon>
          {elapsedLabel}
        </span>
      </div>
    </div>

   <div class="tab-bar">

    <div class={leadTabClass} data-tab="lead" onclick={handleTabClick}>
        Lead Information
    </div>

    <div class={historyTabClass} data-tab="history" onclick={handleTabClick}>
        Call History
    </div>

    <div class={webinarTabClass} data-tab="webinar" onclick={handleTabClick}>
        Webinar History
    </div>

    <div class={eventTabClass} data-tab="event" onclick={handleTabClick}>
        Event History
    </div>

    <div class="view-more-wrap">
        <a onclick={handleViewMoreLead} class="view-more-link">View More</a>
    </div>

</div>



    <template if:true={loading}>
      <div class="loading-state">
        <lightning-spinner alternative-text="Sending..." size="small"></lightning-spinner>
        <div class="loading-text">Calling Runo Allocation API...</div>
      </div>
    </template>

    <!-- <template if:true={showCallPopup}>
      <div class="call-overlay">
        <div class="popup-inner wave-container">
          <div class="popup-call-icon pulse-icon">
            <lightning-icon icon-name="utility:call" size="large"></lightning-icon>
          </div>

          <div class="popup-text">Calling Runo...</div>

          <div class="wave-loader">
            <span></span><span></span><span></span><span></span>
          </div>

          <template if:true={canEndCall}>
            <div class="slds-m-top_medium">
              <lightning-button variant="destructive" label="End Call" onclick={handleEndCall}>
              </lightning-button>
            </div>
          </template>
        </div>
      </div>
    </template> -->

    <template if:true={errorText}>
      <div class="error-box">
        <div class="error-inner">
          <lightning-icon icon-name="utility:error" size="x-small" class="error-icon"></lightning-icon>
          <div class="error-message">{errorText}</div>
        </div>
      </div>
    </template>

    <!-- ===== BODY ===== -->
    <div class="body-wrapper">


      <template if:true={isLeadTab}>
        <div class="content-row two-col-layout">


          <div class="left-panel">
            <div class="section-card">
              <div class="section-header">
                <lightning-icon icon-name="standard:lead" size="small"></lightning-icon>
                <span>Lead Information</span>
              </div>

              <div class="info-grid">
                <div class="info-tile">
                  <lightning-icon icon-name="utility:user"></lightning-icon>
                  <div>
                    <small>Name:-</small>
                    <strong>{identity.name}</strong>
                  </div>
                </div>

                <div class="info-tile">
                  <lightning-icon icon-name="utility:location"></lightning-icon>
                  <div>
                    <small>Location:-</small>
                    <strong>{identity.city}</strong>
                  </div>
                </div>

                <div class="info-tile">
                  <lightning-icon icon-name="utility:topic"></lightning-icon>
                  <div>
                    <small>Course:-</small>
                    <strong>{identity.source}</strong>
                  </div>
                </div>

                <div class="info-tile">
                  <lightning-icon icon-name="utility:collection"></lightning-icon>
                  <div>
                    <small>Stage:-</small>
                    <strong>{identity.stage}</strong>
                  </div>
                </div>

                <div class="info-tile">
                  <lightning-icon icon-name="utility:event"></lightning-icon>
                  <div>
                    <small>Created Date:-</small>
                    <strong>{formattedCreatedDate}</strong>

                  </div>
                </div>

                <div class="info-tile">
                  <lightning-icon icon-name="utility:check"></lightning-icon>
                  <div>
                    <small>MHP:-</small>
                    <strong>{identity.mhpTag}</strong>
                  </div>
                </div>

                <div class="info-tile">
                  <lightning-icon icon-name="utility:user_role"></lightning-icon>
                  <div>
                    <small>Lead Owner:-</small>
                    <strong>{identity.leadOwner}</strong>
                  </div>
                </div>


                <template if:true={showPopup}>
                  <div class="call-popup">Call Successfully sent</div>
                </template>
              </div>
            </div>
          </div>

          <!-- RIGHT SIDE â€” Feedback -->
          <div class="right-panel">
            <template if:true={showFeedback}>
              <div class="section-card feedback-card">
                <div class="section-header">
                  <lightning-icon icon-name="utility:feedback" size="small"></lightning-icon>
                  <span>Call Feedback</span>
                </div>

                <div class="feedback-grid two-column">

                  <lightning-combobox label="Call Status (L1)" value={l1Value} options={l1Options}
                    onchange={handleL1Change}>
                  </lightning-combobox>

                  <lightning-combobox label="Sub Status (L2)" value={l2Value} options={l2Options}
                    onchange={handleL2Change} disabled={isL2Disabled}>
                  </lightning-combobox>

                  <lightning-combobox label="Stage" value={stageValue} options={stageOptions}
                    onchange={handleStageChange} disabled={isStageDisabled}>
                  </lightning-combobox>

                  <lightning-input type="checkbox" label="Notify Me" checked={notifyMe} onchange={handleNotifyChange}>
                  </lightning-input>

                  <template if:true={isStageDisabled}>
                    <div class="slds-text-color_weak stage-section">
                      Stage not applicable for Not-Connected calls
                    </div>
                  </template>

                  <lightning-textarea class="full-row" label="Comments" value={feedback}
                    onchange={handleFeedbackChange} required={isCommentMandatory}>
                  </lightning-textarea>

                  <lightning-input type="datetime-local" label="Next Follow Up" value={nextFollowUpDate}
                    onchange={handleNextFollowUpDateChange} disabled={autoSetFollowUp}>
                  </lightning-input>

                  <lightning-input type="checkbox" label="Auto set next follow up (+24 hrs)" checked={autoSetFollowUp}
                    onchange={handleAutoSetChange}>
                  </lightning-input>

                </div>
              </div>
            </template>
          </div>

        </div>
      </template>


      <template if:true={isHistoryTab}>
        <div class="section-card history-card">

          <div class="section-header">
            <lightning-icon icon-name="utility:call" size="small"></lightning-icon>
            <span>Call History</span>
          </div>

          <template if:true={hasCallHistory}>
            <div class="call-history-list">
              <template for:each={callHistory} for:item="row">
                <div key={row.id} class="call-history-item">

                  <div class="call-history-left">
                    <div>{row.dateLabel}</div>
                    <div>{row.timeLabel}</div>
                  </div>

                  <div class="call-history-right">
                    <div>{row.durationLabel}</div>
                    <div>{row.status}</div>
                  </div>

                  <div class="call-history-meta">
                    <span>{row.l1}</span>
                    <span>{row.l2}</span>
                    <span>{row.stage}</span>
                  </div>

                </div>
              </template>
            </div>
          </template>

          <template if:false={hasCallHistory}>
            <div class="call-history-empty">No call history found</div>
          </template>

        </div>
      </template>

      <template if:true={isWebinarTab}>
                <div class="section-card history-card">

                    <div class="section-header">
                        <lightning-icon icon-name="standard:event" size="small"></lightning-icon>
                        <span>Webinar History</span>
                    </div>

                    <template if:true={hasWebinarHistory}>
                        <div class="call-history-list">

                            <template for:each={webinarHistory} for:item="row">
                                <div key={row.id} class="call-history-item">

                                    <div class="call-history-left">
                                        <div>{row.name}</div>
                                        <div class="subtle">{row.webinar}</div>
                                    </div>

                                    <div class="call-history-right">
                                        <div>{row.status}</div>
                                        <div>{row.createdDate}</div>
                                    </div>


                                    <template if:true={row.meeting}>
                                        <div class="call-history-meta">
                                            {row.meeting}
                                        </div>
                                    </template>

                                </div>
                            </template>

                        </div>
                    </template>

                    <template if:false={hasWebinarHistory}>
                        <div class="call-history-empty">No webinar records found</div>
                    </template>

                </div>
            </template>


             <template if:true={isEventTab}>
                <div class="section-card history-card">

                    <div class="section-header">
                        <lightning-icon icon-name="standard:event" size="small"></lightning-icon>
                        <span>Event History</span>
                    </div>

                    <template if:true={hasEvents}>
                        <div class="call-history-list">
                            <template for:each={eventHistory} for:item="row">
                                <div key={row.id} class="call-history-item">

                                    <div class="call-history-left">
                                        <strong>{row.subject}</strong>
                                    </div>

                                    <div class="call-history-right">
                                        <span class="badge neutral">
                                {row.attendance}
                            </span>
                                    </div>

                                </div>
                            </template>
                        </div>
                    </template>

                    <template if:false={hasEvents}>
                        <div class="call-history-empty">
                            No events found
                        </div>
                    </template>

                </div>
            </template>

    </div>


    <div slot="footer" class="footer-actions">
      <lightning-button class="footer-btn" variant="neutral" label="Save Disposition" onclick={saveFeedback}
        disabled={disableSaveDispositionBtn}>
      </lightning-button>

      <lightning-button class="footer-btn" variant="neutral" label="Save & Pause" onclick={handlePauseQueue}
        disabled={isQueuePaused}>
      </lightning-button>
    </div>

  </lightning-quick-action-panel>
</template>