<template>
    <!-- Modal Backdrop -->
    <section class="modal-backdrop slds-backdrop slds-backdrop_open"></section>
    
    <!-- Modal Container -->
    <section class="modal-container slds-modal slds-fade-in-open" role="dialog">
        <div class="slds-modal__container call-modal-wrapper">
            
            <!-- Header -->
            <header class="slds-modal__header call-modal-header">
                <button class="slds-button slds-button_icon slds-modal__close slds-button_icon-inverse" 
                        onclick={handleClose}
                        title="Close">
                    <svg class="slds-button__icon slds-button__icon_large" aria-hidden="true">
                        <use xlink:href="/assets/icons/utility-sprite/svg/symbols.svg#close"></use>
                    </svg>
                    <span class="slds-assistive-text">Close</span>
                </button>
                <h2 class="slds-modal__title slds-hyphenate call-modal-title">
                    <svg class="header-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                              d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z">
                        </path>
                    </svg>
                    Call Lead - {identity.name}
                </h2>
            </header>

            <!-- Body -->
            <div class="slds-modal__content call-modal-content" id="modal-content">
                
                <!-- Call Popup Overlay -->
                <template if:true={showCallPopup}>
                    <div class="call-overlay">
                        <div class="popup-inner">
                            <div class="popup-call-icon pulse-icon">
                                <svg class="call-icon-svg" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                          d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z">
                                    </path>
                                </svg>
                            </div>
                            <div class="popup-text">Calling {identity.name}...</div>
                            <div class="wave-loader">
                                <span></span><span></span><span></span><span></span>
                            </div>
                            
                            <!-- End Call Button (After 30s no response) -->
                            <template if:true={canEndCall}>
                                <div class="slds-m-top_medium">
                                    <button class="end-call-btn" onclick={handleEndCall}>
                                        End Call
                                    </button>
                                </div>
                            </template>
                        </div>
                    </div>
                </template>

                <!-- Error Message -->
                <template if:true={errorText}>
                    <div class="error-box">
                        <svg class="error-icon-svg" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                  d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                            </path>
                        </svg>
                        <div class="error-message">{errorText}</div>
                    </div>
                </template>

                <!-- Main Content Grid -->
                <div class="content-grid">
                    
                    <!-- Left: Lead Info -->
                    <div class="section-card">
                        <div class="section-header">
                            <svg class="section-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                      d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z">
                                </path>
                            </svg>
                            <span>Lead Information</span>
                        </div>
                        <div class="section-content">
                            <div class="info-line">
                                <svg class="info-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                          d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z">
                                    </path>
                                </svg>
                                <span>{identity.name}</span>
                            </div>
                            <div class="info-line">
                                <svg class="info-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                          d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z">
                                    </path>
                                </svg>
                                <span>{identity.email}</span>
                            </div>
                            <div class="info-line">
                                <svg class="info-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                          d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z">
                                    </path>
                                </svg>
                                <span>{identity.phone}</span>
                            </div>
                            <div class="info-line">
                                <svg class="info-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                          d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z">
                                    </path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                          d="M15 11a3 3 0 11-6 0 3 3 0 016 0z">
                                    </path>
                                </svg>
                                <span>{identity.city}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Right: Call Status -->
                    <div class="section-card call-status-card">
                        <div class="section-header">
                            <svg class="section-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                      d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z">
                                </path>
                            </svg>
                            <span>Call Status</span>
                            <template if:true={isLive}>
                                <span class="live-badge">LIVE</span>
                            </template>
                        </div>
                        <div class="section-content call-status-content">
                            <div class="call-status-item">
                                <b>Status:</b> {callStatus}
                            </div>
                            <div class="call-status-item">
                                <b>Duration:</b> {elapsedLabel}
                            </div>
                        </div>
                    </div>

                    <!-- Feedback Section -->
                    <template if:true={showFeedback}>
                        <div class="feedback-section">
                            <div class="section-header">
                                <svg class="section-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                          d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                                    </path>
                                </svg>
                                <span>Call Feedback</span>
                            </div>

                            <div class="feedback-grid">
                                <!-- L1 Status -->
                                <lightning-combobox
                                    name="l1"
                                    label="L1 Status"
                                    value={l1Value}
                                    options={l1Options}
                                    onchange={handleL1Change}
                                    class="feedback-input">
                                </lightning-combobox>

                                <!-- L2 Sub Status -->
                                <lightning-combobox
                                    name="l2"
                                    label="L2 Sub Status"
                                    value={l2Value}
                                    options={l2Options}
                                    disabled={isL2Disabled}
                                    onchange={handleL2Change}
                                    class="feedback-input">
                                </lightning-combobox>

                                <!-- Stage -->
                                <lightning-combobox
                                    name="stage"
                                    label="Stage"
                                    value={stageValue}
                                    options={stageOptions}
                                    onchange={handleStageChange}
                                    class="feedback-input">
                                </lightning-combobox>

                                <!-- Course -->
                                <lightning-combobox
                                    name="level"
                                    label="Course"
                                    value={levelValue}
                                    options={levelOptions}
                                    onchange={handleLevelChange}
                                    class="feedback-input">
                                </lightning-combobox>
                            </div>

                            <!-- Comment -->
                            <div class="feedback-comment-section">
                                <label class="feedback-label">
                                    Call Feedback
                                    <template if:true={isCommentMandatory}>
                                        <span class="mandatory-text"> (Mandatory)</span>
                                    </template>
                                    <template if:false={isCommentMandatory}>
                                        <span class="optional-text"> (Optional)</span>
                                    </template>
                                </label>
                                <lightning-textarea
                                    value={feedback}
                                    onchange={handleFeedbackChange}
                                    placeholder="Write call outcomeâ€¦"
                                    maxlength="2000">
                                </lightning-textarea>
                            </div>

                            <!-- Next Follow Up Date -->
                            <lightning-input
                                type="datetime-local"
                                label="Next Follow Up Date"
                                value={nextFollowUpDate}
                                onchange={handleNextFollowUpDateChange}
                                class="feedback-input">
                            </lightning-input>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Footer -->
            <footer class="slds-modal__footer call-modal-footer">
                <button class="footer-btn footer-btn-cancel" onclick={handleClose}>
                    Close
                </button>
                
                <template if:true={showCallButton}>
                    <button class="footer-btn footer-btn-call" onclick={handleCall} disabled={loading}>
                        <template if:false={loading}>
                            <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                      d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z">
                                </path>
                            </svg>
                            Call Now
                        </template>
                        <template if:true={loading}>
                            Calling...
                        </template>
                    </button>
                </template>

                <template if:true={showFeedback}>
                    <button class="footer-btn footer-btn-save" 
                            onclick={handleSaveFeedback} 
                            disabled={isSaveDisabled}>
                        <template if:false={savingFeedback}>
                            Save Feedback
                        </template>
                        <template if:true={savingFeedback}>
                            Saving...
                        </template>
                    </button>
                </template>
            </footer>
        </div>
    </section>
</template>