<template>

    <!-- ================= PRODUCT SEARCH + CART ================= -->
    <template if:false={showCheckout}>

        <!-- PRODUCT SEARCH -->
        <section class="card">
            <div class="card-header">
                <h2 class="section-title">Product Catalog</h2>
            </div>

            <lightning-input
                class="search-box"
                type="search"
                placeholder="Search products by name‚Ä¶"
                onchange={handleSearch}>
            </lightning-input>

            <div class="table-wrapper">
                <table class="custom-table">
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th>SKU</th>
                            <th>Category</th>
                            <th class="text-right">Price</th>
                            <th class="text-center">Action</th>
                        </tr>
                    </thead>
                  <tbody>
    <template if:true={showProducts}>
        <template for:each={filteredProducts} for:item="prod">
            <tr key={prod.id}>
                <td>
                    <strong>{prod.name}</strong>
                </td>
                <td class="muted">{prod.sku}</td>
                <td class="muted">{prod.category}</td>
                <td class="text-right">‚Çπ{prod.price}</td>
                <td class="text-center">
                    <button
                        class="btn-icon primary"
                        data-id={prod.id}
                        onclick={addToCart}>
                        +
                    </button>
                </td>
            </tr>
        </template>
    </template>

    <template if:false={showProducts}>
        <tr>
            <td colspan="5" class="empty">
                No products found
            </td>
        </tr>
    </template>
</tbody>

                </table>
            </div>
        </section>

        <!-- CART -->
        <section class="card">
            <div class="card-header cart-header">
                <h2 class="section-title">
                    Cart Items <span class="badge">{cartCount}</span>
                </h2>
                <div class="subtotal">Subtotal: ‚Çπ{subTotal}</div>
            </div>

            <div class="table-wrapper">
                <table class="custom-table">
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th class="text-center">Qty</th>
                            <th class="text-right">Total</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        <template if:true={hasSelectedProducts}>
                            <template for:each={selectedProducts} for:item="item">
                                <tr key={item.id}>
                                    <td>
                                        <strong>{item.name}</strong>
                                        <div class="muted">‚Çπ{item.price} each</div>
                                    </td>
                                    <td class="text-center qty-cell">
                                        <button class="qty-btn" data-id={item.id} data-action="dec" onclick={updateQty}>‚àí</button>
                                        <span class="qty">{item.quantity}</span>
                                        <button class="qty-btn" data-id={item.id} data-action="inc" onclick={updateQty}>+</button>
                                    </td>
                                    <td class="text-right">‚Çπ{item.total}</td>
                                    <td class="text-center">
                                        <button class="btn-icon danger" data-id={item.id} onclick={removeItem}>
                                            üóë
                                        </button>
                                    </td>
                                </tr>
                            </template>
                        </template>

                        <template if:false={hasSelectedProducts}>
                            <tr>
                                <td colspan="4" class="empty">
                                    No products added to cart
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>

            <div class="action-bar">
                <lightning-button
                    variant="brand"
                    label="Proceed to Checkout"
                    onclick={proceedToCheckout}
                    disabled={disableCreatePurchase}>
                </lightning-button>
            </div>
        </section>

    </template>
    
<!-- ================= ADDRESS MODAL ================= -->
<template if:true={showAddressModal}>
    <div class="modal-backdrop"></div>

    <section class="custom-modal">
        <header class="modal-header">
            <h2>Add {missingAddressType} Address</h2>
            <button class="close-btn" onclick={closeAddressModal}>√ó</button>
        </header>

        <div class="modal-body">
            <div class="address-grid">
                <lightning-input label="Street" data-field="street"></lightning-input>
                <lightning-input label="City" data-field="city"></lightning-input>
                <lightning-input label="State" data-field="state"></lightning-input>
                <lightning-input label="Postal Code" data-field="postal"></lightning-input>
                <lightning-input label="Country" data-field="country"></lightning-input>
            </div>
        </div>

        <footer class="modal-footer">
            <lightning-button
                label="Cancel"
                variant="neutral"
                onclick={closeAddressModal}>
            </lightning-button>

            <lightning-button
                label="Save Address"
                variant="brand"
                onclick={saveAddress}>
            </lightning-button>
        </footer>
    </section>
</template>




    <!-- ================= CHECKOUT ================= -->
    <template if:true={showCheckout}>

        <section class="checkout-container">

            <!-- LEFT COLUMN: ORDER SUMMARY -->
            <div class="checkout-left">
                <div class="summary-card">
                    <a class="back-link" onclick={backToProducts}>‚Üê Back to Products</a>
                    <h2 class="section-title">Order Summary</h2>

                    <template for:each={selectedProducts} for:item="item">
                        <div key={item.id} class="summary-item">
                            <div>
                                <strong>{item.name}</strong>
                                <div class="muted">Qty: {item.quantity} √ó ‚Çπ{item.price}</div>
                            </div>
                            <div class="price">‚Çπ{item.total}</div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- RIGHT COLUMN: ADDRESS + DISCOUNT -->
            <div class="checkout-right">
                
                <!-- SELECT ADDRESS -->
                <div class="summary-card">
                    <h2 class="section-title">Select Address</h2>

                    <lightning-radio-group
                        name="addressType"
                        label="Choose Address"
                        options={addressOptions}
                        value={selectedAddressType}
                        onchange={handleAddressChange}>
                    </lightning-radio-group>
                </div>

                <!-- PAYMENT / DISCOUNT -->
                <div class="summary-card">
                    <h2 class="section-title">Pricing & Discount</h2>

                    <div class="radio-group">
                        <label>
                            <input type="radio" name="discountType" value="percentage"
                                   checked={isPercentage} onchange={handleDiscountType}/>
                            Percentage
                        </label>

                        <label>
                            <input type="radio" name="discountType" value="fixed"
                                   checked={isFixed} onchange={handleDiscountType}/>
                            Fixed Amount
                        </label>
                    </div>

                    <lightning-input
                        type="number"
                        label={discountLabel}
                        value={discountValue}
                        onchange={handleDiscountValue}>
                    </lightning-input>
                    <lightning-input
                        data-id="downPayment"
                        type="number"
                        label="Down Payment (‚Çπ)"
                        value={downPayment}
                        min="0"
                        max={finalPayable}
                        message-when-range-overflow="Down payment cannot exceed total payable."
                        message-when-range-underflow="Down payment cannot be negative."
                        onchange={handleDownPaymentChange}>
                    </lightning-input>

                    <div class="price-row">
                        <span>Subtotal</span>
                        <span>‚Çπ{subTotal}</span>
                    </div>

                    <div class="price-row">
                        <span>Discount</span>
                        <span>- ‚Çπ{discountAmount}</span>
                    </div>

                    <div class="price-row total">
                        <span>Total Payable</span>
                        <span>‚Çπ{finalPayable}</span>
                    </div>

                    <lightning-button
                        class="confirm-btn"
                        variant="brand"
                        label="Confirm Purchase"
                        onclick={confirmPurchase}
                        disabled={disableConfirmPurchase}>
                    </lightning-button>
                </div>

            </div>

        </section>

    </template>

</template>