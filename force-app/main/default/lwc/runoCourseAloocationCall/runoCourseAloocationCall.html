<template>
    <lightning-quick-action-panel
        header=""
        class="panel-wrapper">

        <!-- ================= TOP HEADER BAR ================= -->
        <div class="top-header">
            <div class="top-left">
                <lightning-icon icon-name="utility:call" size="small"></lightning-icon>
                <span class="top-title">Calling via Runo</span>
            </div>

            <div class="top-right">
                <span class="status-label">Status:</span>
                <span class="status-pill ended">{callStatus}</span>

                <span class="duration">
                    <lightning-icon icon-name="utility:clock" size="x-small"></lightning-icon>
                    {elapsedLabel}
                </span>
            </div>
        </div>

        <!-- ================= LOADING STATE ================= -->
        <template if:true={loading}>
            <div class="loading-state">
                <lightning-spinner alternative-text="Sending..." size="small"></lightning-spinner>
                <div class="loading-text">Calling Runo Allocation APIâ€¦</div>
            </div>
        </template>

        <!-- ================= CALL POPUP ================= -->
        <template if:true={showCallPopup}>
            <div class="call-overlay">
                <div class="popup-inner wave-container">
                    <div class="popup-call-icon pulse-icon">
                        <lightning-icon icon-name="utility:call" size="large"></lightning-icon>
                    </div>

                    <div class="popup-text">Calling Runo...</div>

                    <div class="wave-loader">
                        <span></span><span></span><span></span><span></span>
                    </div>

                    <template if:true={canEndCall}>
                        <div class="slds-m-top_medium">
                            <lightning-button
                                variant="destructive"
                                label="End Call"
                                onclick={handleEndCall}>
                            </lightning-button>
                        </div>
                    </template>
                </div>
            </div>
        </template>

        <!-- ================= ERROR ================= -->
        <template if:true={errorText}>
            <div class="error-box">
                <div class="error-inner">
                    <lightning-icon icon-name="utility:error" size="x-small"></lightning-icon>
                    <div class="error-message">{errorText}</div>
                </div>
            </div>
        </template>

        <!-- ================= BODY ================= -->
        <div class="body-wrapper">
            <div class="slds-grid slds-gutters slds-wrap">

                <!-- ================= LEFT CARD : LEAD INFO ================= -->
                <div class="slds-col slds-size_1-of-1 slds-large-size_1-of-2">
                    <div class="section-card">

                        <div class="section-header">
                            <lightning-icon icon-name="standard:lead" size="small"></lightning-icon>
                            <span>Lead Information</span>
                        </div>

                        <div class="info-grid">

                            <div class="info-tile">
                                <lightning-icon icon-name="utility:user"></lightning-icon>
                                <div>
                                    <small>Name</small>
                                    <strong>{identity.name}</strong>
                                </div>
                            </div>

                            <div class="info-tile">
                                <lightning-icon icon-name="utility:location"></lightning-icon>
                                <div>
                                    <small>Location</small>
                                    <strong>{identity.city}</strong>
                                </div>
                            </div>

                            <div class="info-tile">
                                <lightning-icon icon-name="utility:topic"></lightning-icon>
                                <div>
                                    <small>Company</small>
                                    <strong>{identity.source}</strong>
                                </div>
                            </div>

                            <div class="info-tile">
                                <lightning-icon icon-name="utility:collection"></lightning-icon>
                                <div>
                                    <small>Stage</small>
                                    <strong>{identity.stage}</strong>
                                </div>
                            </div>

                            <template if:true={showPopup}>
                <div class="call-popup">
                    Call Successfully sent
                </div>
            </template>

                        </div>
                    </div>
                </div>
<template if:true={showFeedback}>
                <!-- ================= RIGHT CARD : CALL FEEDBACK ================= -->
                <div class="slds-col slds-size_1-of-1 slds-large-size_1-of-2">
                    <div class="section-card">

                        <div class="section-header">
                            <lightning-icon icon-name="utility:feedback" size="small"></lightning-icon>
                            <span>Call Feedback</span>
                        </div>

                        <div class="section-content slds-grid slds-wrap slds-gutters">

                            <div class="slds-col slds-size_1-of-2">
                                <lightning-combobox
                                    label="Call Status (L1)"
                                    value={l1Value}
                                    options={l1Options}
                                    onchange={handleL1Change}>
                                </lightning-combobox>
                            </div>

                            <div class="slds-col slds-size_1-of-2">
                                <lightning-combobox
                                    label="Sub Status (L2)"
                                    value={l2Value}
                                    options={l2Options}
                                    onchange={handleL2Change}
                                    disabled={isL2Disabled}>
                                </lightning-combobox>
                            </div>

                            <div class="slds-col slds-size_1-of-1">
                                <lightning-textarea
                                    label="Feedback Comment"
                                    value={feedback}
                                    onchange={handleFeedbackChange}
                                    placeholder="Enter your feedback...">
                                </lightning-textarea>
                            </div>

                            <div class="slds-col slds-size_1-of-2">
                                <lightning-input
                                    type="date"
                                    label="Next Follow Up"
                                    value={nextFollowUpDate}
                                    onchange={handleNextFollowUpDateChange}
                                    disabled={autoSetFollowUp}>
                                </lightning-input>
                            </div>

                            <div class="slds-col slds-size_1-of-2">
                                <lightning-input
                                    type="time"
                                    label="Time"
                                    value={nextFollowUpTime}
                                    onchange={handleNextFollowUpTimeChange}
                                    disabled={autoSetFollowUp}>
                                </lightning-input>
                            </div>

                            <div class="slds-col slds-size_1-of-1 slds-m-top_small">
                                <lightning-input
                                    type="checkbox"
                                    label="Auto set next follow up (+24 hrs)"
                                    checked={autoSetFollowUp}
                                    onchange={handleAutoSetChange}>
                                </lightning-input>
                            </div>

                            <div class="slds-col slds-size_1-of-1 slds-m-top_medium">
                                <lightning-button
                                    variant="brand"
                                    class="full-width"
                                    label="Save Feedback"
                                    onclick={saveFeedback}
                                    disabled={isSaveDisabled}>
                                </lightning-button>
                            </div>

                        </div>
                    </div>
                </div>

            </div>

            <!-- SMALL SUCCESS POPUP -->
            
  </template>
        </div>
        </div>
      

        <!-- ================= FOOTER ================= -->
        <div slot="footer" class="footer-actions">
            <lightning-button
                class="call-btn"
                variant="brand"
                label={callButtonLabel}
                onclick={callApi}
                disabled={callButtonDisabled}>
            </lightning-button>
        </div>

    </lightning-quick-action-panel>
</template>