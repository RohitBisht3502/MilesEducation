<template>
  <div class="panel-wrap">
    <div class="panel-header slds-p-around_medium">
      <h1 class="slds-text-heading_medium">Webinar Registration</h1>
      <p class="slds-text-body_small">You can register this lead for a webinar.</p>
    </div>

    <div class="slds-p-around_medium slds-border_bottom">
      <lightning-input
        type="search"
        label="Search Webinar"
        placeholder="Search by name or webinar ID"
        value={searchKey}
        oninput={handleSearchChange}>
      </lightning-input>
    </div>

    <template if:true={loading}>
      <div class="slds-p-around_medium slds-text-color_weak">Loading webinars...</div>
    </template>

    <template if:false={loading}>
      <template if:true={hasWebinars}>
        <div class="slds-scrollable_y webinar-table" style="max-height: 24rem;">
          <table class="slds-table slds-table_cell-buffer slds-table_bordered slds-table_striped">
            <thead>
              <tr class="slds-line-height_reset table-head-row">
                <th scope="col"><div class="slds-truncate" title="Webinar">Webinar</div></th>
                <th scope="col"><div class="slds-truncate" title="Start Time">Start Time</div></th>
                <th scope="col"><div class="slds-truncate" title="Status">Status</div></th>
                <th scope="col" class="slds-text-align_right"><div class="slds-truncate" title="Actions">Actions</div></th>
              </tr>
            </thead>
            <tbody>
              <template for:each={webinars} for:item="w">
                <tr key={w.id}>
                  <td>
                    <div class="slds-truncate" title={w.name}>{w.name}</div>
                    <div class="slds-text-color_weak slds-text-body_small">ID: {w.webinarId}</div>
                  </td>
                  <td>
                    <lightning-formatted-date-time
                      value={w.startDateTime}
                      year="numeric"
                      month="short"
                      day="2-digit"
                      hour="2-digit"
                      minute="2-digit">
                    </lightning-formatted-date-time>
                  </td>
                  <td>
                    <span class="status-pill">{w.status}</span>
                  </td>
                  <td class="slds-text-align_right">
                    <lightning-button
                      class="slds-m-right_x-small"
                      label="Details"
                      variant="neutral"
                      onclick={openDetails}
                      data-id={w.id}>
                    </lightning-button>

                    <template if:true={w.isRegistered}>
                      <lightning-button label="Registered" variant="success" disabled></lightning-button>
                    </template>

                    <template if:false={w.isRegistered}>
                      <lightning-button
                        label="Register"
                        variant="brand"
                        onclick={openConfirm}
                        data-id={w.id}
                        disabled={saving}>
                      </lightning-button>
                    </template>
                  </td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
      </template>

      <template if:false={hasWebinars}>
        <div class="slds-p-around_medium slds-text-color_weak">No webinars found.</div>
      </template>
    </template>

    <template if:true={confirmOpen}>
      <section role="dialog" aria-modal="true" class="slds-modal slds-fade-in-open">
        <div class="slds-modal__container slds-modal_small">
          <header class="slds-modal__header modal-header-blue">
            <h2 class="slds-text-heading_medium">Confirm Registration</h2>
          </header>

          <div class="slds-modal__content slds-p-around_medium">
            <p>
              Are you sure you want to register this lead for
              <strong>{selectedWebinar.name}</strong>?
            </p>
          </div>

          <footer class="slds-modal__footer">
            <lightning-button variant="neutral" label="Cancel" onclick={closeConfirm}></lightning-button>
            <lightning-button variant="brand" label="Yes, Register" onclick={confirmRegister} disabled={saving}></lightning-button>
          </footer>
        </div>
      </section>
      <div class="slds-backdrop slds-backdrop_open"></div>
    </template>

    <template if:true={detailsOpen}>
      <section role="dialog" aria-modal="true" class="slds-modal slds-fade-in-open">
        <div class="slds-modal__container slds-modal_medium">
          <header class="slds-modal__header modal-header-blue">
            <h2 class="slds-text-heading_medium">Webinar Details</h2>
          </header>

          <div class="slds-modal__content slds-p-around_medium">
            <dl class="slds-list_horizontal slds-wrap">
              <dt class="slds-item_label slds-truncate" title="Name">Name:</dt>
              <dd class="slds-item_detail slds-truncate">{selectedWebinar.name}</dd>

              <dt class="slds-item_label slds-truncate" title="Webinar ID">Webinar ID:</dt>
              <dd class="slds-item_detail slds-truncate">{selectedWebinar.webinarId}</dd>

              <dt class="slds-item_label slds-truncate" title="Status">Status:</dt>
              <dd class="slds-item_detail slds-truncate">{selectedWebinar.status}</dd>

              <dt class="slds-item_label slds-truncate" title="Topic">Topic:</dt>
              <dd class="slds-item_detail">{selectedWebinar.topic}</dd>

              <dt class="slds-item_label slds-truncate" title="Agenda">Agenda:</dt>
              <dd class="slds-item_detail details-text">{selectedWebinar.agenda}</dd>

              <dt class="slds-item_label slds-truncate" title="Start Time">Start Time:</dt>
              <dd class="slds-item_detail">
                <lightning-formatted-date-time
                  value={selectedWebinar.startDateTime}
                  year="numeric"
                  month="short"
                  day="2-digit"
                  hour="2-digit"
                  minute="2-digit">
                </lightning-formatted-date-time>
              </dd>

              <dt class="slds-item_label slds-truncate" title="End Time">End Time:</dt>
              <dd class="slds-item_detail">
                <lightning-formatted-date-time
                  value={selectedWebinar.endDateTime}
                  year="numeric"
                  month="short"
                  day="2-digit"
                  hour="2-digit"
                  minute="2-digit">
                </lightning-formatted-date-time>
              </dd>
            </dl>
          </div>

          <footer class="slds-modal__footer">
            <lightning-button variant="neutral" label="Close" onclick={closeDetails}></lightning-button>
          </footer>
        </div>
      </section>
      <div class="slds-backdrop slds-backdrop_open"></div>
    </template>
  </div>
</template>